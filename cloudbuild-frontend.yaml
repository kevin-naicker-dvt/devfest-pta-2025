# Cloud Build configuration for Frontend
# Triggered on push to main branch OR manually with backend URL
# Builds Docker image and deploys to Cloud Run

substitutions:
  _REGION: 'us-central1'
  _SERVICE_NAME: 'devfest-frontend'
  # Override this with actual backend URL during deployment
  _API_URL: 'https://devfest-backend-XXXXXXXX.run.app'

steps:
  # Step 1: Get Backend URL automatically (if deployed)
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'get-backend-url'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Try to get backend URL
        BACKEND_URL=$(gcloud run services describe devfest-backend \
          --region=${_REGION} \
          --format="value(status.url)" 2>/dev/null || echo "${_API_URL}")
        
        echo "Using Backend URL: $BACKEND_URL"
        echo "$BACKEND_URL" > /workspace/backend_url.txt

  # Step 2: Build the Docker image with backend URL
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-frontend-image'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        BACKEND_URL=$(cat /workspace/backend_url.txt)
        echo "Building frontend with REACT_APP_API_URL=$BACKEND_URL"
        
        docker build \
          -t gcr.io/$PROJECT_ID/devfest-frontend:$SHORT_SHA \
          -t gcr.io/$PROJECT_ID/devfest-frontend:latest \
          -f docker/Dockerfile.frontend \
          --build-arg REACT_APP_API_URL=$BACKEND_URL \
          .
    timeout: '900s'
    waitFor: ['get-backend-url']

  # Step 3: Push the image with commit SHA
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-frontend-sha'
    args:
      - 'push'
      - 'gcr.io/$PROJECT_ID/devfest-frontend:$SHORT_SHA'
    waitFor: ['build-frontend-image']

  # Step 4: Push the image with latest tag
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-frontend-latest'
    args:
      - 'push'
      - 'gcr.io/$PROJECT_ID/devfest-frontend:latest'
    waitFor: ['build-frontend-image']

  # Step 5: Deploy to Cloud Run
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'deploy-frontend'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Deploying frontend to Cloud Run..."
        gcloud run deploy ${_SERVICE_NAME} \
          --image=gcr.io/$PROJECT_ID/devfest-frontend:$SHORT_SHA \
          --platform=managed \
          --region=${_REGION} \
          --allow-unauthenticated \
          --port=80 \
          --memory=256Mi \
          --cpu=1 \
          --min-instances=0 \
          --max-instances=10 \
          --timeout=300 \
          --concurrency=80
        
        echo "âœ… Frontend deployed successfully!"
    waitFor: ['push-frontend-sha']

  # Step 6: Get and display the frontend URL
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'get-frontend-url'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        FRONTEND_URL=$(gcloud run services describe ${_SERVICE_NAME} \
          --region=${_REGION} \
          --format="value(status.url)")
        
        BACKEND_URL=$(cat /workspace/backend_url.txt)
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Frontend deployed successfully!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ğŸ¨ Frontend URL: $FRONTEND_URL"
        echo "ğŸ”— Backend URL:  $BACKEND_URL"
        echo ""
        echo "ğŸš€ Open in browser: $FRONTEND_URL"
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    waitFor: ['deploy-frontend']

# Store images in Container Registry
images:
  - 'gcr.io/$PROJECT_ID/devfest-frontend:$SHORT_SHA'
  - 'gcr.io/$PROJECT_ID/devfest-frontend:latest'

# Build timeout
timeout: '1800s'

# Options
options:
  machineType: 'N1_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY

# Tags for identifying the build
tags: ['frontend', 'ui', 'devfest', 'cloud-run']

