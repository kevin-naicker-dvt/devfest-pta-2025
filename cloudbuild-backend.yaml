# Cloud Build configuration for Backend API
# Triggered on push to main branch
# Builds Docker image and deploys to Cloud Run

substitutions:
  _REGION: 'us-central1'
  _SERVICE_NAME: 'devfest-backend'
  _INSTANCE_CONNECTION_NAME: '${PROJECT_ID}:us-central1:devfest-postgres'
  _DB_NAME: 'devfest_db'
  _DB_USER: 'devfest_user'

steps:
  # Step 1: Build the Docker image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-backend-image'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/devfest-backend:$SHORT_SHA'
      - '-t'
      - 'gcr.io/$PROJECT_ID/devfest-backend:latest'
      - '-f'
      - 'docker/Dockerfile.backend'
      - '.'
    timeout: '600s'

  # Step 2: Push the image with commit SHA
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-backend-sha'
    args:
      - 'push'
      - 'gcr.io/$PROJECT_ID/devfest-backend:$SHORT_SHA'
    waitFor: ['build-backend-image']

  # Step 3: Push the image with latest tag
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-backend-latest'
    args:
      - 'push'
      - 'gcr.io/$PROJECT_ID/devfest-backend:latest'
    waitFor: ['build-backend-image']

  # Step 4: Deploy to Cloud Run
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'deploy-backend'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Get DB password from Secret Manager
        DB_PASSWORD=$(gcloud secrets versions access latest --secret="db-password")
        
        echo "Deploying backend to Cloud Run..."
        gcloud run deploy ${_SERVICE_NAME} \
          --image=gcr.io/$PROJECT_ID/devfest-backend:$SHORT_SHA \
          --platform=managed \
          --region=${_REGION} \
          --allow-unauthenticated \
          --add-cloudsql-instances=${_INSTANCE_CONNECTION_NAME} \
          --set-env-vars="DB_HOST=/cloudsql/${_INSTANCE_CONNECTION_NAME},DB_PORT=5432,DB_NAME=${_DB_NAME},DB_USER=${_DB_USER},DB_PASSWORD=$DB_PASSWORD,NODE_ENV=production,BACKEND_PORT=8080" \
          --port=8080 \
          --memory=512Mi \
          --cpu=1 \
          --min-instances=0 \
          --max-instances=10 \
          --timeout=300 \
          --concurrency=80
        
        echo "âœ… Backend deployed successfully!"
    waitFor: ['push-backend-sha']

  # Step 5: Get and display the backend URL
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'get-backend-url'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        BACKEND_URL=$(gcloud run services describe ${_SERVICE_NAME} \
          --region=${_REGION} \
          --format="value(status.url)")
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Backend API deployed successfully!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ğŸ”— Backend URL: $BACKEND_URL"
        echo ""
        echo "Test endpoints:"
        echo "  Health: $BACKEND_URL/api/health"
        echo "  Hello:  $BACKEND_URL/api/hello"
        echo "  Apps:   $BACKEND_URL/api/applications"
        echo ""
        echo "Use this URL for frontend deployment!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    waitFor: ['deploy-backend']

# Store images in Container Registry
images:
  - 'gcr.io/$PROJECT_ID/devfest-backend:$SHORT_SHA'
  - 'gcr.io/$PROJECT_ID/devfest-backend:latest'

# Build timeout
timeout: '1800s'

# Options
options:
  machineType: 'N1_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY

# Tags for identifying the build
tags: ['backend', 'api', 'devfest', 'cloud-run']

